name: $(date:yyyyMMdd)$(rev:.r)

trigger: none

pr:
  branches:
    include:
      - main
  paths:
    include:
      - TeePee/*
      - TeePee.PR.yml

pool:
  vmImage: "windows-latest"

variables:
  solution: "**/TeePee.sln"
  projectToPack: "TeePee/TeePee/TeePee.csproj"
  netstandardFramework: "netstandard2.1"
  buildConfiguration: "Release"
  NUGET_PACKAGES: $(Pipeline.Workspace)/.nuget/packages

steps:
  - task: UseDotNet@2
    displayName: "Use .NET 10"
    inputs:
      version: 10.x

  - task: Cache@2
    displayName: "NuGet Pipeline Cache"
    inputs:
      key: 'nuget | "$(Agent.OS)" | TeePee/**/packages.lock.json,!**/bin/**,!**/obj/**'
      restoreKeys: |
        nuget | "$(Agent.OS)"
        nuget
      path: "$(NUGET_PACKAGES)"

  - task: DotNetCoreCLI@2
    displayName: "Restore Solution"
    inputs:
      command: "restore"
      projects: "$(solution)"
      arguments: "-c $(buildConfiguration)"

  - task: DotNetCoreCLI@2
    displayName: "Build Solution"
    inputs:
      command: "build"
      projects: "$(solution)"
      arguments: "-c $(buildConfiguration) --no-restore"

  - task: DotNetCoreCLI@2
    displayName: "Restore netstandard"
    inputs:
      command: "restore"
      projects: "$(projectToPack)"
      arguments: "-c $(buildConfiguration) -f $(netstandardFramework)"

  - task: DotNetCoreCLI@2
    displayName: "Build netstandard"
    inputs:
      command: "build"
      projects: "$(projectToPack)"
      arguments: "-c $(buildConfiguration) -f $(netstandardFramework) --no-restore"

  - task: DotNetCoreCLI@2
    displayName: "Unit Tests"
    inputs:
      command: "test"
      projects: "TeePee/**/*[Tt]ests.csproj"
      arguments: "-c $(buildConfiguration) --no-build -- -results-directory $(Agent.TempDirectory) -report-trx"
